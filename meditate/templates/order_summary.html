{% extends "base.html" %} 
{% load static %}
<!-- Expects context params: "order", base.html expects "request" -->

{% block extrahead %}
    <title>Your Order</title>
    <script type="text/javascript">
        var itemTotals = {};
            
        $(function() {
            {% for item in order.orderitem_set.all %}
                itemTotals[{{item.saleItem.id}}] = {{item.saleItem.price}} * {{item.count}};
            {% endfor %}
            UpdateOrderTotal();
        });
            
        function AddToCartLocal(saleItemName, saleItemId) {
            // Adds an item to the cart & updates the count displayed in the order summary
            //  as well as the cart total items.
            function afterAddToCart() {
                // This is to replace the displayed count for this item with the current value.
                urlTemplate = '{% url "single_item_count" "saleItemNamePlaceholder" %}';
                singleItemCountUrl = urlTemplate.replace('saleItemNamePlaceholder', saleItemName);

                $.ajax({
                    type: 'GET',
                    url: singleItemCountUrl,
                    success: function(responsedata) {
                        updateOrderCount();
                        countId = 'sale_item_' + saleItemId;
                        el = document.getElementById(countId);
                        el.innerHTML = responsedata.count;
                        itemTotals[saleItemId] = responsedata.count * responsedata.price;
                        UpdateOrderTotal();
                    },
                    failure: function(XMLHttpRequest, textStatus, errorThrown) {
                        var msg = `Unable to add "${saleItemName}" to cart` 
                        alert(msg); // TODO: Remove this.

                        var logUrl = '{% url "log_javascript" "msgPlaceholder" %}'
                        logUrl = logUrl.replace('msgPlaceholder', msg)
                        $.ajax({
                            type: 'GET',
                            url: logUrl,
                        });
                    }
                });
            }
            // This adds an item to the cart & updates the cart total.
            AddToCart(saleItemName, callback=afterAddToCart);
        }
            
        function RemoveFromCartLocal(saleItemName, saleItemId) {
            // Removes an item from the cart & updates the count displayed in the order summary
            //  as well as the cart total items.
            function afterRemoveFromCart() {
                // This is to replace the displayed count for this item with the current value.
                urlTemplate = '{% url "single_item_count" "saleItemNamePlaceholder" %}';
                singleItemCountUrl = urlTemplate.replace('saleItemNamePlaceholder', saleItemName);
                
                $.ajax({
                    type: 'GET',
                    url: singleItemCountUrl,
                    success: function(responsedata) {
                        updateOrderCount();
                        countId = 'sale_item_' + saleItemId;
                        el = document.getElementById(countId);
                        el.innerHTML = responsedata.count;
                        itemTotals[saleItemId] = responsedata.count * responsedata.price;
                        UpdateOrderTotal();
                    },
                    failure: function(XMLHttpRequest, textStatus, errorThrown) {
                        var msg = `Unable to add "${saleItemName}" to cart` 
                        alert(msg); // TODO: Remove this.
                        var logUrl = '{% url "log_javascript" "msgPlaceholder" %}'
                        logUrl = logUrl.replace('msgPlaceholder', msg)
                        $.ajax({
                            type: 'GET',
                            url: logUrl,
                        });
                    }
                });
            }
            // This removes an item from the cart on the back end & updates the cart total.
            RemoveFromCart(saleItemName, callback=afterRemoveFromCart);
        }

        function getOrderTotal() {
            var orderTotal = 0;
            Object.keys(itemTotals).forEach(function(key) {
                orderTotal += itemTotals[key]; // itemTotals is in dollars, convert to cents.
            });
            return orderTotal;
        }

        function UpdateOrderTotal() {
            // Returns the total price of the entire cart. 
            total = getOrderTotal();
            var el = document.getElementById('total');
            totalText = '$' + total + ' (USD)';
            el.innerHTML = totalText;
        }
    </script>
{% endblock %} 

{% block content %}
    <div class="wrapper-cart">
        <h3 class="cart-heading">
            <font class="wrapper-banner-title sample-title">Shopping Cart</font>
        </h3>
        {% if order.orderitem_set.count %}
            <div class="row table-heading">
                <div class="col-md-2 col-sm-3 col-3 item-image text-center position">
                    ITEMS
                </div>
                <div class="col-md-4 col-sm-6 col-5 description position">
                </div>
                <div class="col-md-2 price text-center position">
                    PRICE
                </div>
                <div class="col-md-2 quantity text-center position">
                    QTY
                </div>
                <div class="col-md-2 col-sm-3 col-4 total text-center position">
                    TOTAL
                </div>
            </div>
            <hr> 
            {% for item in order.orderitem_set.all %}
                <div class="row table-contents">
                    <div class="col-md-2 col-sm-3 col-3 item-image text-center position">
                        <img class="cart-img" src='{% static item.saleItem.img %}'></img>
                    </div>
                    <div class="col-md-4 col-sm-6 col-5 description position">
                        <u>Meditation, Mind and Body ({{item.saleItem.name}})</u>
                        <br>
                        <input type='button' class='custom-button button-add' onclick='AddToCartLocal("{{item.saleItem.name}}", {{item.saleItem.id}})'>&nbsp;
                        <input type='button' class='custom-button button-remove' onclick='RemoveFromCartLocal("{{item.saleItem.name}}", {{item.saleItem.id}})'>
                    </div>
                    <div class="col-md-2 price text-center position">
                        ${{item.saleItem.price}}
                    </div>
                    <div class="col-md-2 quantity text-center position">
                        <input type='button' class='custom-button button-add' onclick='AddToCartLocal("{{item.saleItem.name}}", {{item.saleItem.id}})'>&nbsp;
                        <input type='button' class='custom-button button-remove' onclick='RemoveFromCartLocal("{{item.saleItem.name}}", {{item.saleItem.id}})'>
                    </div>
                    <div class="col-md-2 col-sm-3 col-4 total text-center position">
                        <span>${{item.saleItem.price}} * </span>
                        <span id="sale_item_{{item.saleItem.id}}">{{item.count}}</span>
                    </div>
                </div>
            {% endfor %}
            <hr style="border-top: dashed 1.5px; color: #a9a9a9;" />
            <div id='payment' class="float-right payment">
                Subtotal &emsp; <span id='total'>$0.00</span>
            </div>
            <div class="clearfix"></div>
            
            <button id="customButton" class="btn btn-secondary float-right checkout">CHECKOUT</button>
            <div class="float-right mt-2 custom-margin">
                <div id="paypal-button-container" class="mr-3"></div>
            </div>
            <div class="clearfix"></div>
            <div class="text mt-4"><em>*I take your privacy very seriously.  Using these two highly-secure payment services,
                my website never sees your payment details, only a notification that you've paid.  Even
                if someone was able to hack my website, your financial details would not be compromised.</em>
            </div>
        {% else %}
            <div class="blog-content">
                <h3>Your Shopping Cart is empty. Go to the buy page and add the books to your cart.</h3>
                <h3 class="continue-link"><a href="/buy_book">Continue shopping</a></h3>
            </div>
        {% endif %}

        <!------------------------------- STRIPE-SPECIFIC CODE --------------------------------------->
        <script src="https://checkout.stripe.com/checkout.js"></script>
        <script type='text/javascript' src="{% static 'js/order/stripe.js' %}"></script>

        <!------------------------------- PAYPAL-SPECIFIC CODE --------------------------------------->

        <script src="https://www.paypalobjects.com/api/checkout.js"></script>
        <script type='text/javascript' src="{% static 'js/order/paypal.js' %}"></script>
    </div>
{% endblock %}
